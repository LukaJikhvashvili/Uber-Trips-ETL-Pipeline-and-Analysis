name: dbt Build

on:
  push:
    branches: [ main ]

jobs:
  dbt:
    runs-on: ubuntu-latest

    env:
      DBT_PROFILES_DIR: .
      SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
      SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
      SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
      SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
      SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dbt
        run: |
          python -m pip install --upgrade pip
          pip install dbt-core dbt-snowflake

      - name: Install dbt deps
        run: dbt deps

      # Restore previous state (if exists)
      - name: Restore dbt state
        uses: actions/cache@v4
        with:
          path: .artifacts
          key: dbt-state-${{ github.ref }}
          restore-keys: |
            dbt-state-

      - name: dbt seed
        run: dbt seed --target ci

      - name: dbt build (modified models only)
        run: |
          if [ -f .artifacts/manifest.json ]; then
            dbt build \
              --target ci \
              --select state:modified+ \
              --state .artifacts
          else
            dbt build --target ci
          fi

      # Save new state
      - name: Save dbt state
        run: |
          mkdir -p .artifacts
          cp target/manifest.json .artifacts/
